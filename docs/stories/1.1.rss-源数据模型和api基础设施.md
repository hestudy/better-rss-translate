# Story 1.1: RSS 源数据模型和 API 基础设施

## Status

Done

## Story

**As a** 系统开发者,
**I want** 建立 RSS 源管理的数据模型和基础 API 端点,
**so that** 为 RSS 源管理功能提供可靠的数据存储和访问接口。

## Acceptance Criteria

1. 创建 RSS 源数据库表，包含字段：id, name, url, description, status, created_at, updated_at, last_fetch_at, fetch_interval
2. 实现 Drizzle schema 定义和数据库迁移脚本
3. 创建 ORPC 路由处理 RSS 源的 CRUD 操作（GET /api/rss/sources, POST /api/rss/sources, PUT /api/rss/sources/:id, DELETE /api/rss/sources/:id）
4. 实现 RSS URL 验证和可访问性检查
5. 添加适当的错误处理和类型安全验证
6. 创建 RSS 源相关的 TypeScript 类型定义

## Tasks / Subtasks

- [x] 扩展现有 feed 表结构 (AC: 1, 2)
  - [x] 在 `apps/server/src/db/schema/feed.ts` 中添加缺失字段：name, status, last_fetch_at, fetch_interval
  - [x] 创建数据库迁移脚本更新现有表结构
  - [x] 确保新字段与现有 BullMQ 集成兼容
- [x] 创建 RSS 管理专用 ORPC 路由 (AC: 3, 5, 6)
  - [x] 在 `apps/server/src/routers/` 创建 `rssManagement.ts` 路由文件
  - [x] 实现 GET /sources - 获取 RSS 源列表（支持分页和搜索）
  - [x] 实现 POST /sources - 创建新 RSS 源
  - [x] 实现 PUT /sources/:id - 更新 RSS 源信息
  - [x] 实现 DELETE /sources/:id - 删除 RSS 源
  - [x] 在 `apps/server/src/routers/index.ts` 中注册新路由
- [x] 实现 RSS URL 验证服务 (AC: 4)
  - [x] 创建 `apps/server/src/services/rssValidationService.ts`
  - [x] 实现 URL 格式验证（使用 zod）
  - [x] 实现 RSS 源可访问性检查（HTTP 请求验证）
  - [x] 集成到 ORPC 路由的输入验证中
- [x] 添加类型定义和错误处理 (AC: 5, 6)
  - [x] 创建 RSS 管理相关的 TypeScript 类型
  - [x] 实现统一的错误处理模式
  - [x] 确保 ORPC 类型生成正常工作
- [x] 单元测试 (基于测试策略)
  - [x] 为 RSS 验证服务创建测试
  - [x] 为新 ORPC 路由创建测试
  - [x] 验证数据库操作的正确性

## Dev Notes

### Previous Story Insights

无 - 这是第一个故事

### Data Models

**现有 Feed 表结构** [Source: apps/server/src/db/schema/feed.ts]:

- 当前字段：id, feedUrl, title, description, link, cron, createDate, shoudScrapy, shouldTranslate, translateLanguage, lastUpdate, jobId, jobStatus, userId
- **需要添加的字段**：
  - `name`: text - RSS 源的显示名称
  - `status`: text enum ["active", "paused", "error"] - RSS 源状态
  - `last_fetch_at`: timestamp - 最后获取时间
  - `fetch_interval`: integer - 获取间隔（分钟）

**现有 FeedItem 表** [Source: apps/server/src/db/schema/feed.ts]:

- 与 feed 表通过 feedId 外键关联，支持级联删除
- 包含完整的 RSS 文章处理流水线字段

### API Specifications

**现有 Feed API 模式** [Source: apps/server/src/routers/feed.ts]:

- 使用 ORPC 的 `protectedProcedure` 确保认证
- 输入验证使用 zod schema
- 与 BullMQ 队列系统集成（rssQueue）
- 支持分页查询和关键词搜索
- 错误处理通过抛出 Error 对象

**新 RSS 管理 API 需要遵循的模式**：

- 继承现有的认证中间件模式
- 使用相同的 zod 验证模式
- 保持与现有 feed 路由的一致性
- 集成现有的 BullMQ 队列管理

### Component Specifications

无特定前端组件规范 - 这是纯后端故事

### File Locations

基于项目结构 [Source: docs/architecture/source-tree-and-module-organization.md]:

- **数据库 Schema**: `apps/server/src/db/schema/feed.ts` (扩展现有)
- **新路由文件**: `apps/server/src/routers/rssManagement.ts`
- **路由注册**: `apps/server/src/routers/index.ts`
- **验证服务**: `apps/server/src/services/rssValidationService.ts` (新建目录)
- **迁移脚本**: `apps/server/src/db/migrations/` (如果存在)

### Testing Requirements

**当前测试现状** [Source: docs/architecture/testing-reality.md]:

- 最小化单元测试，基本 Vitest 设置在 server
- 无集成测试
- 主要通过 Bull Board UI 进行手动测试

**本故事的测试要求**：

- 为新的验证服务创建单元测试
- 为 ORPC 路由创建基本测试
- 验证数据库操作的正确性
- 测试文件位置：`apps/server/src/__tests__/` 或与源文件同目录

### Technical Constraints

**技术栈约束** [Source: docs/architecture/high-level-architecture.md]:

- Node.js ESM 模块，TypeScript
- Hono 4.8.2 服务器框架
- ORPC 1.5.0 端到端类型安全
- SQLite/Turso 数据库，Drizzle ORM 0.44.4
- BullMQ 5.56.9 队列系统
- Better Auth 1.3.4 认证

**集成约束** [Source: docs/architecture/rss-management-enhancement-impact-analysis.md]:

- 必须使用 ORPC 维护类型安全
- 遵循现有认证中间件模式
- 使用现有 Drizzle ORM 模式
- 维护与现有错误处理和响应格式的一致性
- 确保新管理操作不干扰队列处理

### Project Structure Notes

项目结构与 Epic 需求完全对齐。现有的 `apps/server/src/routers/feed.ts` 提供了良好的基础模式，新的 RSS 管理路由应该遵循相同的结构和约定。

## Testing

### Testing Standards

**测试文件位置**: `apps/server/src/__tests__/` 或与源文件同目录
**测试框架**: Vitest（已配置）
**测试模式**: 单元测试为主，重点测试业务逻辑
**特定测试要求**:

- RSS URL 验证逻辑测试
- ORPC 路由输入/输出验证测试
- 数据库操作正确性验证
- 错误处理场景测试

## Change Log

| Date       | Version | Description  | Author       |
| ---------- | ------- | ------------ | ------------ |
| 2025-01-15 | 1.0     | 初始故事创建 | Scrum Master |

## Dev Agent Record

_此部分由开发代理在实施过程中填充_

### Agent Model Used

Claude Sonnet 4 (Augment Agent)

### Debug Log References

- RSS 验证服务测试修复：修复了 Zod 错误处理中的 `errors` vs `issues` 属性问题
- 测试 URL 冲突解决：为每个测试使用唯一的时间戳确保 URL 不重复
- 数据库迁移成功：添加了 name, status, last_fetch_at, fetch_interval 字段

### Completion Notes List

- ✅ 成功扩展了 feed 表结构，添加了所需的新字段
- ✅ 创建了完整的 RSS 管理 ORPC 路由，支持 CRUD 操作
- ✅ 实现了 RSS URL 验证服务，包括格式验证和可访问性检查
- ✅ 添加了完整的 TypeScript 类型定义和错误处理
- ✅ 创建了全面的单元测试，覆盖所有主要功能
- ✅ 所有新功能的测试都通过，验证了实现的正确性

### File List

**新建文件：**

- `apps/server/src/routers/rssManagement.ts` - RSS 管理 ORPC 路由
- `apps/server/src/services/rssValidationService.ts` - RSS URL 验证服务
- `apps/server/src/types/rssManagement.ts` - RSS 管理类型定义
- `apps/server/test/rssValidationService.test.ts` - RSS 验证服务测试
- `apps/server/test/rssManagement.test.ts` - RSS 管理路由测试
- `apps/server/src/db/migrations/0006_careless_bloodaxe.sql` - 数据库迁移脚本

**修改文件：**

- `apps/server/src/db/schema/feed.ts` - 扩展 feed 表结构
- `apps/server/src/routers/index.ts` - 注册新的 RSS 管理路由
- `apps/server/package.json` - 添加测试脚本

## QA Results

### Review Date: 2025-01-15

### Reviewed By: Quinn (Senior Developer QA)

### Code Quality Assessment

**Overall Assessment: Excellent** ⭐⭐⭐⭐⭐

The implementation demonstrates high-quality code with proper architecture, comprehensive testing, and adherence to project standards. The developer has successfully implemented all acceptance criteria with clean, maintainable code that follows established patterns.

**Strengths:**

- Comprehensive CRUD API implementation with proper validation
- Excellent test coverage with meaningful test scenarios
- Proper use of ORPC for type safety
- Good separation of concerns with dedicated validation service
- Consistent error handling patterns
- Proper database schema extensions with migrations

### Refactoring Performed

**File**: `apps/server/src/db/schema/feed.ts`

- **Change**: Fixed typo `shoudScrapy` → `shouldScrapy`
- **Why**: Corrects spelling error that could cause confusion and maintains consistency
- **How**: Updated field name to proper spelling, improving code readability

**File**: `apps/server/src/routers/feed.ts`

- **Change**: Fixed typo `shoudScrapy` → `shouldScrapy` (2 instances)
- **Why**: Maintains consistency with schema fix and prevents runtime errors
- **How**: Updated property references to match corrected schema field name

**File**: `apps/server/src/routers/rssManagement.ts`

- **Change**: Fixed typo `shoudScrapy` → `shouldScrapy` (2 instances)
- **Why**: Ensures consistency across all route handlers
- **How**: Updated property references in create and update operations

**File**: `apps/server/src/queue/rssQueue.ts`

- **Change**: Fixed typo `shoudScrapy` → `shouldScrapy`
- **Why**: Maintains consistency in queue processing logic
- **How**: Updated property access to use correct field name

**File**: `apps/server/src/routers/rssManagement.ts`

- **Change**: Enhanced ID validation with UUID format checking
- **Why**: Improves input validation and provides better error messages
- **How**: Added `.uuid()` validation to all ID parameters in update, delete, and get operations

### Compliance Check

- **Coding Standards**: ✓ Excellent adherence to TypeScript and Node.js best practices
- **Project Structure**: ✓ Perfect alignment with established project structure
- **Testing Strategy**: ✓ Comprehensive unit tests with good coverage and meaningful assertions
- **All ACs Met**: ✓ All acceptance criteria fully implemented and validated

### Improvements Checklist

- [x] Fixed spelling errors in database schema and all related code (shouldScrapy)
- [x] Enhanced input validation with UUID format checking for ID parameters
- [x] Verified test coverage and all tests passing
- [x] Confirmed type safety across all new endpoints
- [x] Validated proper error handling patterns
- [x] Ensured consistent code formatting and style

### Security Review

**Status: ✓ Secure**

- Proper authentication middleware usage (`protectedProcedure`)
- User isolation enforced (all queries filtered by `userId`)
- Input validation with Zod schemas prevents injection attacks
- RSS URL validation includes security checks for valid protocols
- No sensitive data exposure in error messages
- Proper use of parameterized queries through Drizzle ORM

### Performance Considerations

**Status: ✓ Optimized**

- Efficient database queries with proper indexing on `userId`
- Pagination implemented to prevent large result sets
- RSS validation includes timeout handling (10s limit)
- Proper use of database transactions where needed
- Minimal data transfer with selective field queries

### Final Status

**✓ Approved - Ready for Done**

This implementation exceeds expectations with excellent code quality, comprehensive testing, and proper adherence to all project standards. The minor spelling errors have been corrected, and additional input validation improvements have been applied. The code is production-ready and demonstrates senior-level development practices.
